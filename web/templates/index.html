{% extends "layouts/app.html" %}

{% block js %}
var maps;
var new_marker;
var points = new Array();
var adding = false;
var markers = new Array();
var timeouts = new Array();
{%for point in points%}
    po  = new google.maps.LatLng({{point.latitude}}, {{point.longitude}});
    points.push({'point':po, 'id': {{point.id}}});
{%endfor%}
function showMsg() {
    maps.showMsg("welcome",  'Aquí tienes las últimas <br>zonas añadidas!', 350, 230, false);
}

{% endblock %}
{% block jquery_init %}
function loadPoints() {
     $.ajax({
            url: "/point/get_last_points/",
            method: 'GET',
            dataType: 'json',
            data:'',
            success: function(data) {
                if (data.success) {
                    for (i = 0; i < data.points.length;i++) {
                        point = data.points[i];
                        var timeout = setTimeout((function(point) { return function() {
                            marker = maps.addMarker( new google.maps.LatLng(point.lat , point.lng), point.id);
                            markers.push(marker);
                        };
                        })(point), i*300);
                        timeouts.push(timeout);
                    }
                }
            }
         });

}
function loadMap(data) {
    maps = data;
    loadPoints();
   setTimeout('showMsg()',1500);
}
$("#add_point").click(function() {
    if (adding) {
        adding = false;
        loadPoints();
        $("#add_point").text("Añadir zona");
    } else {
         adding = true;
         removeMarkers();
         for (index in timeouts) {
            clearTimeout(timeouts[index]);
         }
         $("#add_point").text("Cancelar");
     }
});

function removeMarkers() {
    markers.forEach(function(value, clave) {
        value.setMap(null); 
    });
}
            
function add_point(e) {
    if (!adding) return;
    if (new_marker) {
         new_marker.setMap(null);
    }
    new_marker = maps.addMarker(e.latLng);
     $.ajax({
            url: "/point/add_point/",
            method: 'GET',
            dataType: 'json',
            data:'',
            success: function(data) {
                if (data.success) {
                    $.fancybox(data.html,
                        {'onClosed'		: function() {
                          new_marker.setMap(null);
                          $("#add_point").trigger("click");
                       }});
                    $("#id_latitude").val(e.latLng.lat());
                    $("#id_longitude").val(e.latLng.lng());
                    $('#my_form').ajaxForm(function() { 
                        $.fancybox.close()
                        $("#add_point").trigger("click");
                    }); 
                }
            } 
        });
}
$("#route").click(function() {
     $.ajax({
            url: "/point/get_route_form/",
            method: 'GET',
            dataType: 'json',
            data:'',
            success: function(data) {
                if (data.success) {
                    $.fancybox(data.html,
                        {'onClosed'		: function() {
                       }});
                   $("#do_route").click(function() {
                        removeMarkers();
                        maps.calcRoute($("#id_source").val(), $("#id_target").val(), points);
                        $.fancybox.close();
                    });
                }
            } 
        });
});
Maps(loadMap, add_point);

{% endblock %}

{% block page %}
   
    <div id="map_canvas">
    </div> <!-- map -->

{% endblock %}

