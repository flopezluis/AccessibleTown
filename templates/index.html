{% extends "layouts/app.html" %}

{% block js %}
var maps;
var new_marker;
var points = new Array();
var adding = false;
var markers = new Array();
{%for point in points%}
    po  = new google.maps.LatLng({{point.latitude}}, {{point.longitude}});
    points.push({'point':po, 'id': {{point.id}}});
{%endfor%}
function showMsg() {
    maps.showMsg("welcome",  'Aquí tienes las últimas <br>zonas añadidas!', 350, 230, false);
}

{% endblock %}
{% block jquery_init %}
function loadPoints() {
    for (i = 0; i < points.length;i++) {
        point = points[i];
        setTimeout((function(point) { return function() {
            marker = maps.addMarker( new google.maps.LatLng(point.point.lat() , point.point.lng()), point.id);
            markers.push(marker);
        };
        })(point), i*500);
    }
}
function loadMap(data) {
    maps = data;
    loadPoints();
   setTimeout('showMsg()',1500);
}
$("#add_point").click(function() {
    if (adding) {
        adding = false;
        loadPoints();
        $("#add_point").text("Añadir zona");
    } else {
         adding = true;
         markers.forEach(function(value, clave) {
            value.setMap(null); 
         });
         $("#add_point").text("Cancelar");
     }
});

            
function add_point(e) {
    if (!adding) return;
    if (new_marker) {
         new_marker.setMap(null);
    }
    new_marker = maps.addMarker(e.latLng);
     $.ajax({
            url: "/point/add_point/",
            method: 'GET',
            dataType: 'json',
            data:'',
            success: function(data) {
                if (data.success) {
                    $.fancybox(data.html,
                        {'onClosed'		: function() {
                          new_marker.setMap(null);
                       }});
                    $("#id_latitude").val(e.latLng.lat());
                    $("#id_longitude").val(e.latLng.lng());
                    $('#my_form').ajaxForm(function() { 
                        alert("Guardo con éxito"); 
                    }); 
                }
            } 
        });
}
Maps(loadMap, add_point);

{% endblock %}

{% block page %}
   
    <div id="map_canvas">
    </div> <!-- map -->

{% endblock %}

